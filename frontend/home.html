<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸ªäººä¸»é¡µ - Blog Management</title>
  <link rel="stylesheet" href="./static/css/styles.css">
</head>
<body>
  <div class="main-container">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="main-header">
      <div class="header-content">
        <h1>Blog Management</h1>
        <nav class="main-nav">
          <ul class="nav-options">
            <li class="nav-option active" data-section="articles">
              <i class="icon">ğŸ“</i> æ–‡ç« 
            </li>
            <li class="nav-option" data-section="profile">
              <i class="icon">ğŸ‘¤</i> ä¸ªäººèµ„æ–™
            </li>
            <li class="nav-option" data-section="settings">
              <i class="icon">âš™ï¸</i> è®¾ç½®
            </li>
          </ul>
        </nav>
        <button id="logout-btn" class="logout-button">é€€å‡ºç™»å½•</button>
      </div>
    </header>

    <!-- å†…å®¹åŒºåŸŸ -->
    <main class="content-area">
      <!-- æ–‡ç« ç®¡ç†åŒºåŸŸ -->
      <section id="articles-section" class="section-content active">
        <div class="section-header">
          <h2>æ–‡ç« ç®¡ç†</h2>
          <div class="header-actions">
            <button id="show-all-btn" class="btn-large btn-secondary">æ˜¾ç¤ºæ‰€æœ‰æ–‡ç« </button>
            <button id="create-article-btn" class="btn-large btn-primary">åˆ›å»ºæ–‡ç« </button>
          </div>
        </div>

        <!-- æ–‡ç« åˆ—è¡¨ -->
        <div class="article-list">
          <div id="article-loading" class="loading">åŠ è½½ä¸­...</div>
          <div id="article-list-container"></div>
          <div id="no-articles" class="empty-state" style="display: none;">
            <p>æš‚æ— æ–‡ç« ï¼Œç‚¹å‡»"åˆ›å»ºæ–‡ç« "æŒ‰é’®æ·»åŠ </p>
          </div>
        </div>
      </section>

      <!-- ä¸ªäººèµ„æ–™åŒºåŸŸ -->
      <section id="profile-section" class="section-content" style="display: none;">
        <h2>ä¸ªäººèµ„æ–™</h2>
        <p>ä¸ªäººèµ„æ–™åŠŸèƒ½å¼€å‘ä¸­...</p>
      </section>

      <!-- è®¾ç½®åŒºåŸŸ -->
      <section id="settings-section" class="section-content" style="display: none;">
        <h2>è®¾ç½®</h2>
        <p>è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...</p>
      </section>
    </main>
  </div>

  <!-- åˆ›å»º/ç¼–è¾‘æ–‡ç« æ¨¡æ€æ¡† -->
  <div id="article-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">åˆ›å»ºæ–‡ç« </h3>
        <button id="close-modal" class="close-btn">Ã—</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="article-id">
        <div class="form-group">
          <label for="article-title">æ ‡é¢˜</label>
          <input type="text" id="article-title" placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜">
        </div>
        <div class="form-group">
          <label for="article-content">å†…å®¹</label>
          <textarea id="article-content" rows="8" placeholder="è¯·è¾“å…¥æ–‡ç« å†…å®¹"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancel-modal" class="btn-large btn-secondary">å–æ¶ˆ</button>
        <button id="save-article" class="btn-large btn-primary">ä¿å­˜</button>
      </div>
      <div id="modal-error" class="error-message" style="display: none;"></div>
    </div>
  </div>

  <!-- ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡† -->
  <div id="confirm-modal" class="modal" style="display: none;">
    <div class="modal-content confirm-modal">
      <h3>ç¡®è®¤åˆ é™¤</h3>
      <p>ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
      <div class="modal-footer">
        <button id="cancel-delete" class="btn-large btn-secondary">å–æ¶ˆ</button>
        <button id="confirm-delete" class="btn-large btn-danger">åˆ é™¤</button>
      </div>
    </div>
  </div>

  <!-- æ–‡ç« è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div id="article-detail-modal" class="modal" style="display: none;">
    <div class="modal-content article-detail">
      <div class="modal-header">
        <h2 id="detail-title"></h2>
        <button id="close-detail" class="close-btn">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="article-meta">
          <span id="detail-author">ä½œè€…: </span>
          <span id="detail-time">å‘å¸ƒæ—¶é—´: </span>
          <span id="detail-likes">ğŸ‘ </span>
        </div>
        <div id="detail-content" class="article-content"></div>
      </div>
      <div class="modal-footer">
        <button id="close-detail-btn" class="btn-large btn-primary">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- å®Œæ•´çš„JavaScriptåŠŸèƒ½å®ç° -->
  <script type="module">
    import { getUser, removeUser } from './static/js/utils.js';
    import { getMyArticles, getAllArticles, createArticle, updateArticle, deleteArticle, getArticleDetail, changeArticleLike } from './static/js/api.js';

    // å½“å‰ç¼–è¾‘çš„æ–‡ç« ID
    let currentArticleId = null;
    // å½“å‰æ˜¾ç¤ºæ¨¡å¼ (my: è‡ªå·±çš„æ–‡ç« , all: æ‰€æœ‰æ–‡ç« )
    let currentMode = 'my';

    // DOM å…ƒç´ 
    const logoutBtn = document.getElementById('logout-btn');
    const navOptions = document.querySelectorAll('.nav-option');
    const sections = document.querySelectorAll('.section-content');
    const articleListContainer = document.getElementById('article-list-container');
    const articleLoading = document.getElementById('article-loading');
    const noArticles = document.getElementById('no-articles');
    const showAllBtn = document.getElementById('show-all-btn');
    const createArticleBtn = document.getElementById('create-article-btn');
    const articleModal = document.getElementById('article-modal');
    const modalTitle = document.getElementById('modal-title');
    const closeModal = document.getElementById('close-modal');
    const cancelModal = document.getElementById('cancel-modal');
    const saveArticleBtn = document.getElementById('save-article');
    const articleIdInput = document.getElementById('article-id');
    const articleTitleInput = document.getElementById('article-title');
    const articleContentInput = document.getElementById('article-content');
    const modalError = document.getElementById('modal-error');
    const confirmModal = document.getElementById('confirm-modal');
    const cancelDeleteBtn = document.getElementById('cancel-delete');
    const confirmDeleteBtn = document.getElementById('confirm-delete');

    // åˆå§‹åŒ–é¡µé¢
    async function init() {
      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
      const user = getUser();
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      
      // æ˜ç¡®è®¾ç½®æŒ‰é’®åˆå§‹æ–‡æœ¬
      showAllBtn.textContent = 'æ˜¾ç¤ºæ‰€æœ‰æ–‡ç« ';
      
      // åŠ è½½æ–‡ç« åˆ—è¡¨
      await loadArticles();
      
      // ç»‘å®šäº‹ä»¶
      bindEvents();
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
      // é€€å‡ºç™»å½•
      logoutBtn.addEventListener('click', () => {
        removeUser();
        window.location.href = 'index.html';
      });

      // å¯¼èˆªé€‰é¡¹ç‚¹å‡»äº‹ä»¶
      navOptions.forEach(item => {
        item.addEventListener('click', () => {
          const sectionId = item.getAttribute('data-section');
          switchSection(sectionId);
        });
      });

      // æ˜¾ç¤ºæ‰€æœ‰æ–‡ç« æŒ‰é’®
      showAllBtn.addEventListener('click', async () => {
        if (currentMode === 'all') {
          currentMode = 'my';
          showAllBtn.textContent = 'æ˜¾ç¤ºæ‰€æœ‰æ–‡ç« ';
        } else {
          currentMode = 'all';
          showAllBtn.textContent = 'æ˜¾ç¤ºæˆ‘çš„æ–‡ç« ';
        }
        await loadArticles();
      });

      // åˆ›å»ºæ–‡ç« æŒ‰é’®
      createArticleBtn.addEventListener('click', () => {
        openCreateModal();
      });

      // æ¨¡æ€æ¡†äº‹ä»¶
      closeModal.addEventListener('click', closeArticleModal);
      cancelModal.addEventListener('click', closeArticleModal);
      saveArticleBtn.addEventListener('click', saveArticle);

      // ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡†äº‹ä»¶
      cancelDeleteBtn.addEventListener('click', () => {
        confirmModal.style.display = 'none';
      });
      confirmDeleteBtn.addEventListener('click', handleConfirmDelete);
    }

    // åˆ‡æ¢åŒºåŸŸ
    function switchSection(sectionId) {
      // æ›´æ–°å¯¼èˆªé€‰é¡¹çš„æ¿€æ´»çŠ¶æ€
      navOptions.forEach(option => {
        if (option.getAttribute('data-section') === sectionId) {
          option.classList.add('active');
        } else {
          option.classList.remove('active');
        }
      });

      // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹åŒºåŸŸ
      sections.forEach(section => {
        if (section.id === `${sectionId}-section`) {
          section.style.display = 'block';
          section.classList.add('active');
        } else {
          section.style.display = 'none';
          section.classList.remove('active');
        }
      });
    }

    // åŠ è½½æ–‡ç« åˆ—è¡¨
    async function loadArticles() {
      articleLoading.style.display = 'block';
      articleListContainer.innerHTML = '';
      noArticles.style.display = 'none';

      try {
        let responseData;
        if (currentMode === 'my') {
          responseData = await getMyArticles();
        } else {
          responseData = await getAllArticles();
        }
        
        // ä»å“åº”æ•°æ®ä¸­æå–æ–‡ç« æ•°ç»„ï¼Œç¡®ä¿å¤„ç†å¤šç§å¯èƒ½çš„è¿”å›æ ¼å¼
        const articles = responseData.data && Array.isArray(responseData.data) ? 
                         responseData.data : 
                         (responseData.articles && Array.isArray(responseData.articles) ? 
                         responseData.articles : []);

        if (articles.length === 0) {
          noArticles.style.display = 'block';
        } else {
          renderArticleList(articles);
        }
      } catch (error) {
        console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
        showError('åŠ è½½æ–‡ç« å¤±è´¥ï¼Œè¯·é‡è¯•');
      } finally {
        articleLoading.style.display = 'none';
      }
    }

    // æ¸²æŸ“æ–‡ç« åˆ—è¡¨
    function renderArticleList(articles) {
      // è·å–å½“å‰ç™»å½•ç”¨æˆ·
      const currentUser = getUser();
      
      articles.forEach(article => {
        const articleItem = document.createElement('div');
        articleItem.className = 'article-item';
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºæ–‡ç« ä½œè€…
        const isAuthor = currentUser && currentUser.id === article.AuthorID;
        
        // æ ¹æ®æ˜¯å¦ä¸ºä½œè€…å†³å®šæ˜¯å¦ç¦ç”¨ç¼–è¾‘åˆ é™¤æŒ‰é’®
        const buttonDisabled = isAuthor ? '' : 'disabled';
        const buttonClass = isAuthor ? '' : 'disabled-btn';
        
        articleItem.innerHTML = `
        <div class="article-header">
        <h3 class="article-title" data-id="${article.id}">${article.title}</h3>
        <div class="article-meta">
        <span class="author">ä½œè€…: ${article.Users?.username || 'æœªçŸ¥'}</span>
        <div class="like-section">
        <button class="like-btn" data-id="${article.id}" data-liked="false">ğŸ‘</button>
        <span class="like-count">${article.like_count || 0}</span>
        </div>
        </div>
        </div>
        <div class="article-actions">
        <button class="edit-btn ${buttonClass}" data-id="${article.id}" ${buttonDisabled}>ç¼–è¾‘</button>
        <button class="delete-btn ${buttonClass}" data-id="${article.id}" ${buttonDisabled}>åˆ é™¤</button>
        </div>
        `;
        articleListContainer.appendChild(articleItem);
      });
      // æ·»åŠ äº‹ä»¶ç›‘å¬
      document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', handleEditArticle);
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', handleDeleteArticle);
      });
      document.querySelectorAll('.article-title').forEach(title => {
      title.addEventListener('click', function() {
      const articleId = parseInt(this.getAttribute('data-id'));
      loadArticleDetail(articleId);
      });
      });
      
      // æ·»åŠ ç‚¹èµæŒ‰é’®äº‹ä»¶ç›‘å¬
      document.querySelectorAll('.like-btn').forEach(btn => {
      btn.addEventListener('click', async function(e) {
      e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°æ–‡ç« æ ‡é¢˜
      const articleId = parseInt(this.getAttribute('data-id'));
      const isLiked = this.getAttribute('data-liked') === 'true';
      const likeCountElement = this.nextElementSibling;
      
      try {
      // 1è¡¨ç¤ºç‚¹èµï¼Œ-1è¡¨ç¤ºå–æ¶ˆç‚¹èµ
      const count = isLiked ? -1 : 1;
      await changeArticleLike(articleId, count);
      
      // æ›´æ–°UI
      this.setAttribute('data-liked', !isLiked);
      const currentLikes = parseInt(likeCountElement.textContent);
      likeCountElement.textContent = currentLikes + count;
      
      // ä¸ºç‚¹èµæŒ‰é’®æ·»åŠ åŠ¨ç”»æ•ˆæœ
      this.classList.add('like-animation');
      setTimeout(() => {
      this.classList.remove('like-animation');
      }, 500);
      } catch (error) {
      console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
      showError('ç‚¹èµæ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
      });
      });
      }

      // æ‰“å¼€åˆ›å»ºæ¨¡æ€æ¡†
      function openCreateModal() {
        currentArticleId = null;
        modalTitle.textContent = 'åˆ›å»ºæ–‡ç« ';
        articleIdInput.value = '';
        articleTitleInput.value = '';
        articleContentInput.value = '';
        modalError.style.display = 'none';
        articleModal.style.display = 'block';
      }

      // å¤„ç†ç¼–è¾‘æ–‡ç« 
      async function handleEditArticle() {
        const id = this.getAttribute('data-id');
        await openEditModal(id);
      }

      // å¤„ç†åˆ é™¤æ–‡ç« 
      function handleDeleteArticle() {
        currentArticleId = this.getAttribute('data-id');
        confirmModal.style.display = 'block';
      }

      // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
      async function openEditModal(id) {
        try {
          // è·å–æ–‡ç« è¯¦æƒ…
          const responseData = await getArticleDetail(id);
          const article = responseData.data || responseData;
          
          if (article) {
            currentArticleId = id;
            modalTitle.textContent = 'ç¼–è¾‘æ–‡ç« ';
            articleIdInput.value = id;
            articleTitleInput.value = article.title || '';
            articleContentInput.value = article.content || '';
            modalError.style.display = 'none';
            articleModal.style.display = 'block';
          }
        } catch (error) {
          console.error('åŠ è½½æ–‡ç« è¯¦æƒ…å¤±è´¥:', error);
          showError('åŠ è½½æ–‡ç« è¯¦æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      }

      // å…³é—­æ–‡ç« æ¨¡æ€æ¡†
      function closeArticleModal() {
        articleModal.style.display = 'none';
      }

      // ä¿å­˜æ–‡ç« 
      async function saveArticle() {
        const title = articleTitleInput.value.trim();
        const content = articleContentInput.value.trim();

        if (!title || !content) {
          showModalError('æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º');
          return;
        }

        try {
          if (currentArticleId) {
            await updateArticle({ id: currentArticleId, title, content });
          } else {
            await createArticle({ title, content });
          }
          
          closeArticleModal();
          await loadArticles();
        } catch (error) {
          console.error('ä¿å­˜æ–‡ç« å¤±è´¥:', error);
          showModalError(error.message || 'ä¿å­˜æ–‡ç« å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      }

      // å¤„ç†ç¡®è®¤åˆ é™¤
      async function handleConfirmDelete() {
        if (!currentArticleId) return;

        try {
          await deleteArticle(currentArticleId);
          confirmModal.style.display = 'none';
          await loadArticles();
        } catch (error) {
          console.error('åˆ é™¤æ–‡ç« å¤±è´¥:', error);
          showError('åˆ é™¤æ–‡ç« å¤±è´¥ï¼Œè¯·é‡è¯•');
          confirmModal.style.display = 'none';
        }
      }

      // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
      function showError(message) {
        const errorElement = document.createElement('div');
        errorElement.className = 'error-message';
        errorElement.textContent = message;
        document.body.appendChild(errorElement);

        // 3ç§’åè‡ªåŠ¨ç§»é™¤é”™è¯¯æ¶ˆæ¯
        setTimeout(() => {
          errorElement.remove();
        }, 3000);
      }

      // æ˜¾ç¤ºæ¨¡æ€æ¡†é”™è¯¯æ¶ˆæ¯
      function showModalError(message) {
        modalError.textContent = message;
        modalError.style.display = 'block';
      }

      // åŠ è½½å¹¶æ˜¾ç¤ºæ–‡ç« è¯¦æƒ…
      async function loadArticleDetail(id) {
        const detailModal = document.getElementById('article-detail-modal');
        const detailTitle = document.getElementById('detail-title');
        const detailAuthor = document.getElementById('detail-author');
        const detailTime = document.getElementById('detail-time');
        const detailLikes = document.getElementById('detail-likes');
        const detailContent = document.getElementById('detail-content');
        
        try {
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          detailTitle.textContent = 'åŠ è½½ä¸­...';
          detailContent.textContent = '';
          detailModal.style.display = 'block';
          
          // è·å–æ–‡ç« è¯¦æƒ…
          const responseData = await getArticleDetail(id);
          // ä¿®æ”¹è¿™è¡Œï¼Œä»responseData.articleè·å–æ•°æ®
          const article = responseData.article || 
                         (responseData.articles && responseData.articles[0]) || 
                         (responseData.data || responseData);
          
          // å¡«å……æ–‡ç« è¯¦æƒ…
          detailTitle.textContent = article.title || 'æ— æ ‡é¢˜';
          detailAuthor.textContent = `ä½œè€…: ${article.Users?.username || 'æœªçŸ¥'}`;
          detailTime.textContent = `å‘å¸ƒæ—¶é—´: ${article.created_at ? new Date(article.created_at).toLocaleString() : 'æœªçŸ¥'}`;
          detailLikes.textContent = `ğŸ‘ ${article.like_count || 0}`;
          detailContent.textContent = article.content || 'æš‚æ— å†…å®¹';
        } catch (error) {
          console.error('åŠ è½½æ–‡ç« è¯¦æƒ…å¤±è´¥:', error);
          showError('åŠ è½½æ–‡ç« è¯¦æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•');
          detailModal.style.display = 'none';
        }
      }

      // å…³é—­æ–‡ç« è¯¦æƒ…æ¨¡æ€æ¡†
      document.getElementById('close-detail').addEventListener('click', function() {
        document.getElementById('article-detail-modal').style.display = 'none';
      });
      document.getElementById('close-detail-btn').addEventListener('click', function() {
        document.getElementById('article-detail-modal').style.display = 'none';
      });

      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      window.addEventListener('click', function(event) {
        const detailModal = document.getElementById('article-detail-modal');
        const articleModal = document.getElementById('article-modal');
        const confirmModal = document.getElementById('confirm-modal');
        
        if (event.target === detailModal) {
          detailModal.style.display = 'none';
        }
        if (event.target === articleModal) {
          articleModal.style.display = 'none';
        }
        if (event.target === confirmModal) {
          confirmModal.style.display = 'none';
        }
      });

      // åˆå§‹åŒ–é¡µé¢
      init();
    </script>
</body>
</html>